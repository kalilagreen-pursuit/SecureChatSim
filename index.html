<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cybersecurity Incident Response - Slack Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slack: {
                            purple: '#4A154B',
                            sidebar: '#3F0E40',
                            hover: '#350D36',
                            green: '#2D9D32',
                            text: '#1D1C1D',
                            light: '#F8F8F8',
                            border: '#E1E1E1'
                        }
                    },
                    fontFamily: {
                        slack: ['Slack-Lato', 'Lato', 'Lucida Grande', 'Lucida Sans Unicode', 'Tahoma', 'Sans-Serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        
        .message-hover:hover {
            background-color: #f8f8f8;
        }
        
        .sidebar-item:hover {
            background-color: #350D36;
        }
        
        .channel-active {
            background-color: #1264A3;
            color: white;
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-white">
    <!-- Main Container -->
    <div class="flex h-full">
        <!-- Sidebar -->
        <div class="w-64 bg-slack-sidebar text-white flex flex-col">
            <!-- Workspace Header -->
            <div class="p-4 border-b border-slack-hover">
                <div class="flex items-center justify-between">
                    <h1 class="text-lg font-bold text-white">SecOps Team</h1>
                    <div class="w-3 h-3 bg-slack-green rounded-full"></div>
                </div>
                <div class="text-sm text-gray-300 mt-1">Security Operations</div>
            </div>
            
            <!-- Navigation Section -->
            <div class="px-4 py-2 border-b border-slack-hover">
                <div class="text-gray-300 text-sm font-semibold mb-2">Applications</div>
                <div class="space-y-1">
                    <a href="dashboard.html" class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300 hover:text-white block">
                        <span class="mr-2">🚨</span>
                        <span class="text-sm">Alert Dashboard</span>
                    </a>
                </div>
            </div>
            
            <!-- Channels Section -->
            <div class="flex-1 overflow-y-auto">
                <div class="px-4 py-2">
                    <div class="text-gray-300 text-sm font-semibold mb-2">Channels</div>
                    <div class="space-y-1">
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer channel-active">
                            <span class="mr-2">#</span>
                            <span class="text-sm">security-alerts</span>
                            <div class="ml-auto w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">1</div>
                        </div>
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300">
                            <span class="mr-2">#</span>
                            <span class="text-sm">incident-response</span>
                        </div>
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300">
                            <span class="mr-2">#</span>
                            <span class="text-sm">threat-intel</span>
                        </div>
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300">
                            <span class="mr-2">#</span>
                            <span class="text-sm">general</span>
                        </div>
                    </div>
                    
                    <!-- Direct Messages -->
                    <div class="text-gray-300 text-sm font-semibold mb-2 mt-6">Direct Messages</div>
                    <div class="space-y-1">
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <span class="text-sm">SecurityBot</span>
                        </div>
                        <div class="flex items-center px-2 py-1 rounded sidebar-item cursor-pointer text-gray-300">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <span class="text-sm">AI Agent</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div class="bg-white border-b border-slack-border px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <h2 class="text-xl font-bold text-slack-text"># security-alerts</h2>
                        <div class="ml-4 text-sm text-gray-500">🔒 Phishing Email Response Playbook</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="text-sm text-gray-500 mt-1">
                    Real-time incident response and automated security playbooks
                </div>
            </div>

            <!-- Chat Messages Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slack-light">
                <!-- Initial Security Alert -->
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        🚨
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-slack-text">SecurityBot</span>
                            <span class="text-xs text-gray-500">APP</span>
                            <span class="text-xs text-gray-500">9:15 AM</span>
                        </div>
                        <div class="bg-white border border-red-200 rounded-lg p-4 mt-2">
                            <div class="text-red-600 font-semibold mb-2">🚨 Security Alert: Phishing Email Detected</div>
                            <div class="text-sm text-gray-700 mb-3">
                                <strong>Incident ID:</strong> INC-2025-001<br>
                                <strong>User:</strong> john.doe@company.com<br>
                                <strong>Email Subject:</strong> "Urgent: Verify Your Account"<br>
                                <strong>Threat Level:</strong> High
                            </div>
                            <div class="text-sm text-gray-600">
                                A suspicious email with potential phishing indicators has been detected in the user's inbox. 
                                The email contains suspicious links and requests urgent action from the user.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Agent Response -->
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        AI
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-slack-text">AI Agent</span>
                            <span class="text-xs text-gray-500">BOT</span>
                            <span class="text-xs text-gray-500">9:16 AM</span>
                        </div>
                        <div class="bg-white rounded-lg p-4 mt-2 border border-gray-200">
                            <div class="text-sm text-gray-700 mb-3">
                                I've analyzed the phishing email incident. Based on the threat indicators, I recommend the following response options:
                            </div>
                            <div class="space-y-2">
                                <button onclick="handleSolutionClick('1', '🔒 Quarantine Email & Notify User')" 
                                        class="w-full text-left bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg p-3 transition-colors">
                                    <div class="font-medium text-green-800">🔒 Quarantine Email & Notify User</div>
                                    <div class="text-sm text-green-600">Immediately isolate the email and alert the user</div>
                                </button>
                                <button onclick="handleSolutionClick('2', '❌ Dismiss as False Positive')"
                                        class="w-full text-left bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg p-3 transition-colors">
                                    <div class="font-medium text-yellow-800">❌ Dismiss as False Positive</div>
                                    <div class="text-sm text-yellow-600">Mark the alert as a false positive</div>
                                </button>
                                <button onclick="handleSolutionClick('3', '🚀 Escalate to Tier 2')"
                                        class="w-full text-left bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg p-3 transition-colors">
                                    <div class="font-medium text-purple-800">🚀 Escalate to Tier 2</div>
                                    <div class="text-sm text-purple-600">Send to senior analyst for review</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="bg-white border-t border-slack-border p-4">
                <div class="flex items-center space-x-3">
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text" id="chat-input" 
                                   placeholder="Message #security-alerts" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <button id="send-btn" 
                            class="bg-slack-green hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        Send
                    </button>
                </div>
                <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                    <div class="flex items-center space-x-4">
                        <button class="hover:text-gray-700">📎</button>
                        <button class="hover:text-gray-700">😀</button>
                        <button class="hover:text-gray-700">@</button>
                    </div>
                    <div>Press ⌘+Enter to send</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple in-memory database to simulate the agent "learning"
        const memoryDB = [];

        // Predefined playbook for agent responses
        const playbook = {
            '1': {
                response: 'Solution "Quarantine Email & Notify User" selected. The email has been quarantined, and an automated notification has been sent to the user.',
                isFinal: true
            },
            '2': {
                response: 'Solution "Dismiss as False Positive" selected. The alert has been marked as a false positive.',
                isFinal: true
            },
            '3': {
                response: 'Solution "Escalate to Tier 2" selected. The incident has been flagged for a senior analyst. Please provide additional context in the chat if needed.',
                isFinal: false
            },
            'default': {
                response: 'I am not sure how to respond to that. Please select one of the provided solutions or provide more context.',
                isFinal: false
            }
        };

        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');

        // Function to add a message to the chat
        const addMessage = (sender, content, type = 'message') => {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3 message-hover rounded-lg p-2';
            
            let avatar, senderName, badge;
            
            if (sender === 'agent') {
                avatar = '🤖';
                senderName = 'AI Agent';
                badge = 'BOT';
            } else if (sender === 'analyst') {
                avatar = '👤';
                senderName = 'Security Analyst';
                badge = 'USER';
            } else {
                avatar = '🔧';
                senderName = 'SecurityBot';
                badge = 'APP';
            }
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm';
            avatarDiv.textContent = avatar;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center space-x-2';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-bold text-slack-text';
            nameSpan.textContent = senderName;
            
            const badgeSpan = document.createElement('span');
            badgeSpan.className = 'text-xs text-gray-500';
            badgeSpan.textContent = badge;
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500';
            timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bg-white rounded-lg p-4 mt-2 border border-gray-200';
            messageDiv.textContent = content;
            
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(badgeSpan);
            headerDiv.appendChild(timeSpan);
            
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(messageDiv);
            
            messageElement.appendChild(avatarDiv);
            messageElement.appendChild(contentDiv);
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Function to add resolution confirmation
        const addResolutionConfirmation = (incidentData) => {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3 message-hover rounded-lg p-2';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm';
            avatarDiv.textContent = '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center space-x-2';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-bold text-slack-text';
            nameSpan.textContent = 'AI Agent';
            
            const badgeSpan = document.createElement('span');
            badgeSpan.className = 'text-xs text-gray-500';
            badgeSpan.textContent = 'BOT';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500';
            timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bg-white rounded-lg p-4 mt-2 border border-gray-200';
            
            const questionText = document.createElement('div');
            questionText.className = 'text-sm text-gray-700 mb-3';
            questionText.textContent = 'Is this incident now resolved?';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-3';
            
            const yesButton = document.createElement('button');
            yesButton.className = 'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors';
            yesButton.textContent = '✅ Yes, Resolved';
            yesButton.onclick = () => {
                yesButton.disabled = true;
                noButton.disabled = true;
                yesButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                noButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                handleResolutionResponse(true, incidentData);
            };
            
            const noButton = document.createElement('button');
            noButton.className = 'bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors';
            noButton.textContent = '❌ No, Needs More Action';
            noButton.onclick = () => {
                yesButton.disabled = true;
                noButton.disabled = true;
                yesButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                noButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                handleResolutionResponse(false, incidentData);
            };
            
            buttonContainer.appendChild(yesButton);
            buttonContainer.appendChild(noButton);
            
            messageDiv.appendChild(questionText);
            messageDiv.appendChild(buttonContainer);
            
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(badgeSpan);
            headerDiv.appendChild(timeSpan);
            
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(messageDiv);
            
            messageElement.appendChild(avatarDiv);
            messageElement.appendChild(contentDiv);
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Function to handle resolution response (Yes or No)
        const handleResolutionResponse = (isResolved, incidentData) => {
            if (isResolved) {
                // Add analyst response
                addMessage('analyst', '✅ Yes, Resolved');
                
                // Store in database and show finalization message
                setTimeout(() => {
                    // Update the finalized timestamp to when user confirms resolution
                    incidentData.finalizedAt = new Date().toISOString();
                    memoryDB.push(incidentData);
                    addMessage('agent', '✅ Solution finalized and stored in the database for future agent training.');
                    console.log('Memory Database:', memoryDB);
                    
                    // Add manager report option
                    setTimeout(() => {
                        addManagerReportOption(incidentData);
                    }, 500);
                }, 800);
            } else {
                // Add analyst response
                addMessage('analyst', '❌ No, Needs More Action');
                
                // Ask for additional measures
                setTimeout(() => {
                    addMessage('agent', 'What additional measures are needed to fully resolve this incident?');
                }, 800);
            }
        };

        // Function to add manager report option
        const addManagerReportOption = (incidentData) => {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex items-start space-x-3 message-hover rounded-lg p-2';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm';
            avatarDiv.textContent = '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center space-x-2';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-bold text-slack-text';
            nameSpan.textContent = 'AI Agent';
            
            const badgeSpan = document.createElement('span');
            badgeSpan.className = 'text-xs text-gray-500';
            badgeSpan.textContent = 'BOT';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500';
            timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bg-white rounded-lg p-4 mt-2 border border-gray-200';
            
            const questionText = document.createElement('div');
            questionText.className = 'text-sm text-gray-700 mb-3';
            questionText.textContent = 'Would you like me to generate a manager report for this incident?';
            
            const generateButton = document.createElement('button');
            generateButton.className = 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors';
            generateButton.textContent = '📊 Generate Manager Report';
            generateButton.onclick = () => {
                generateButton.disabled = true;
                generateButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                generateManagerReport(incidentData);
            };
            
            messageDiv.appendChild(questionText);
            messageDiv.appendChild(generateButton);
            
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(badgeSpan);
            headerDiv.appendChild(timeSpan);
            
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(messageDiv);
            
            messageElement.appendChild(avatarDiv);
            messageElement.appendChild(contentDiv);
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Function to generate manager report
        const generateManagerReport = (incidentData) => {
            // Add processing message
            addMessage('agent', '📊 Generating manager report...');
            
            setTimeout(() => {
                const reportContent = `
**SECURITY INCIDENT REPORT**

**Incident Details:**
- Incident ID: ${incidentData.incidentId}
- Alert Type: ${incidentData.initialAlert}
- Resolution: ${incidentData.selectedSolution}
- Status: Resolved
- Finalized: ${new Date(incidentData.finalizedAt).toLocaleString()}

**Summary:**
A phishing email incident was detected and successfully resolved using automated security playbooks. The selected solution "${incidentData.selectedSolution}" was implemented and confirmed effective by the security analyst.

**Impact:**
- Threat Level: High
- User Affected: john.doe@company.com
- Response Time: < 5 minutes
- Status: Contained and Resolved

**Next Steps:**
- Monitor for similar patterns
- Update security awareness training
- Review email security policies

Report generated automatically by AI Security Agent.
                `.trim();
                
                // Create report message with copy functionality
                const messageElement = document.createElement('div');
                messageElement.className = 'flex items-start space-x-3 message-hover rounded-lg p-2';
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm';
                avatarDiv.textContent = '🤖';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-1';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center space-x-2';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'font-bold text-slack-text';
                nameSpan.textContent = 'AI Agent';
                
                const badgeSpan = document.createElement('span');
                badgeSpan.className = 'text-xs text-gray-500';
                badgeSpan.textContent = 'BOT';
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-xs text-gray-500';
                timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'bg-gray-50 rounded-lg p-4 mt-2 border border-gray-200';
                
                const reportTitle = document.createElement('div');
                reportTitle.className = 'font-semibold text-gray-800 mb-3 flex items-center justify-between';
                reportTitle.innerHTML = '📊 Manager Report Generated';
                
                const reportText = document.createElement('pre');
                reportText.className = 'text-sm text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border';
                reportText.textContent = reportContent;
                
                const copyButton = document.createElement('button');
                copyButton.className = 'mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm';
                copyButton.textContent = '📋 Copy to Clipboard';
                copyButton.onclick = () => {
                    navigator.clipboard.writeText(reportContent).then(() => {
                        copyButton.textContent = '✅ Copied!';
                        setTimeout(() => {
                            copyButton.textContent = '📋 Copy to Clipboard';
                        }, 2000);
                    });
                };
                
                messageDiv.appendChild(reportTitle);
                messageDiv.appendChild(reportText);
                messageDiv.appendChild(copyButton);
                
                headerDiv.appendChild(nameSpan);
                headerDiv.appendChild(badgeSpan);
                headerDiv.appendChild(timeSpan);
                
                contentDiv.appendChild(headerDiv);
                contentDiv.appendChild(messageDiv);
                
                messageElement.appendChild(avatarDiv);
                messageElement.appendChild(contentDiv);
                
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500);
        };

        // Function to handle solution selection
        const handleSolutionClick = (solutionId, solutionText) => {
            // Disable all solution buttons
            const buttons = document.querySelectorAll('button[onclick^="handleSolutionClick"]');
            buttons.forEach(button => {
                button.disabled = true;
                button.className = button.className.replace('hover:bg-', 'bg-gray-100 cursor-not-allowed ');
            });

            // Add analyst response
            addMessage('analyst', `Selected: ${solutionText}`);
            
            // Simulate agent thinking time and response
            setTimeout(() => {
                const agentResponse = playbook[solutionId].response;
                addMessage('agent', agentResponse);
                
                if (playbook[solutionId].isFinal) {
                    // Ask for confirmation instead of automatically finalizing
                    const incidentData = {
                        incidentId: 'INC-' + Date.now(),
                        initialAlert: 'User-reported phishing email',
                        selectedSolution: solutionText
                    };
                    
                    setTimeout(() => {
                        addResolutionConfirmation(incidentData);
                    }, 800);
                }
            }, 1000);
        };

        // Handle chat input
        const handleChatInput = () => {
            const message = chatInput.value.trim();
            if (message) {
                addMessage('analyst', message);
                chatInput.value = '';
                
                // Simple auto-response
                setTimeout(() => {
                    const response = playbook['default'].response;
                    addMessage('agent', response);
                }, 1000);
            }
        };

        // Add SecurityBot message for delegated alerts
        const addSecurityBotMessage = (alertData) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3';
            messageDiv.innerHTML = `
                <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                    🚨
                </div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-bold text-slack-text">SecurityBot</span>
                        <span class="text-xs text-gray-500">APP</span>
                        <span class="text-xs text-gray-500">${alertData.delegatedAt}</span>
                    </div>
                    <div class="mt-1">
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r">
                            <div class="flex items-center mb-2">
                                <span class="font-semibold text-red-700">🚨 Security Alert Delegated: ${alertData.title}</span>
                            </div>
                            <div class="text-sm text-red-600 space-y-1">
                                <div><strong>Description:</strong> ${alertData.description}</div>
                                <div><strong>Affected User:</strong> ${alertData.user}</div>
                                <div><strong>Device:</strong> ${alertData.device}</div>
                                <div><strong>IP Address:</strong> ${alertData.ip}</div>
                                <div class="mt-2 pt-2 border-t border-red-200 text-xs text-gray-600">
                                    Alert ID: ${alertData.id} • Priority: ${alertData.priority.toUpperCase()} • Delegated from Dashboard
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            This alert has been delegated by a senior analyst. Please begin incident response according to established playbooks.
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Listen for delegated alerts from dashboard
        window.addEventListener('storage', (e) => {
            if (e.key === 'delegatedAlerts' && e.newValue) {
                const alerts = JSON.parse(e.newValue);
                const oldAlerts = e.oldValue ? JSON.parse(e.oldValue) : [];
                
                // Find new alerts (ones that weren't in the old list)
                const newAlerts = alerts.filter(alert => 
                    !oldAlerts.some(oldAlert => oldAlert.id === alert.id)
                );
                
                // Add SecurityBot messages for new alerts and track them
                const displayedAlerts = JSON.parse(localStorage.getItem('displayedAlerts') || '[]');
                newAlerts.forEach(alert => {
                    addSecurityBotMessage(alert);
                    displayedAlerts.push({ id: alert.id, timestamp: alert.timestamp });
                });
                
                // Update displayed alerts list if we added new ones
                if (newAlerts.length > 0) {
                    localStorage.setItem('displayedAlerts', JSON.stringify(displayedAlerts));
                }
            }
        });

        // Check for existing delegated alerts on page load
        document.addEventListener('DOMContentLoaded', () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Load any existing delegated alerts that haven't been displayed yet
            const existingAlerts = JSON.parse(localStorage.getItem('delegatedAlerts') || '[]');
            const displayedAlerts = JSON.parse(localStorage.getItem('displayedAlerts') || '[]');
            
            const newAlerts = existingAlerts.filter(alert => 
                !displayedAlerts.some(displayed => displayed.id === alert.id)
            );
            
            newAlerts.forEach(alert => {
                addSecurityBotMessage(alert);
                displayedAlerts.push({ id: alert.id, timestamp: alert.timestamp });
            });
            
            if (newAlerts.length > 0) {
                localStorage.setItem('displayedAlerts', JSON.stringify(displayedAlerts));
            }
        });

        // Event listeners
        sendBtn.addEventListener('click', handleChatInput);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChatInput();
            }
        });
    </script>
</body>
</html>